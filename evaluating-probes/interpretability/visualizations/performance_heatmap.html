<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Probe Performance Heatmap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to the new external stylesheet -->
    <link rel="stylesheet" href="style.css">
    <style>
        /* Keep only essential sticky positioning styles here */
        th { position: sticky; top: 0; background-color: #f8fafc; z-index: 10; }
        .dataset-col { position: sticky; left: 0; background-color: #f8fafc; z-index: 5; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="main-container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Probe Performance Heatmap</h1>
            <p class="text-gray-600 mb-6">This table shows the evaluation score (AUC) for each probe configuration across all datasets. Higher scores (greener) are better.</p>
            
            <div id="loading" class="text-center py-12">
                <p class="text-lg text-gray-500">Loading visualization data...</p>
            </div>

            <div id="visualization" class="hidden overflow-x-auto">
                <table id="heatmap-table" class="w-full text-sm text-left text-gray-500">
                    <!-- Header and body will be generated by JavaScript -->
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('../visualization_data.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}.`);
                const data = await response.json();
                buildTable(data.performance);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('visualization').classList.remove('hidden');
            } catch (error) {
                document.getElementById('loading').innerHTML = `<p class="text-red-500 font-semibold">${error.message}</p>`;
            }
        });

        function buildTable(performanceData) {
            const table = document.getElementById('heatmap-table');
            const pivot = {};
            const allProbes = new Set();
            const allDatasets = new Set();

            performanceData.forEach(item => {
                const probeName = `L${item.layer}_${item.component}_${item.architecture}_${item.aggregation}`;
                const datasetName = item.eval_dataset;
                const score = item.metrics.auc;

                if (!pivot[datasetName]) pivot[datasetName] = {};
                pivot[datasetName][probeName] = score;
                allProbes.add(probeName);
                allDatasets.add(datasetName);
            });

            const sortedProbes = Array.from(allProbes).sort();
            const sortedDatasets = Array.from(allDatasets).sort();

            const thead = document.createElement('thead');
            let headerRow = `<tr class="text-xs text-gray-700 uppercase bg-gray-100"><th scope="col" class="px-6 py-3 dataset-col">Dataset</th>`;
            sortedProbes.forEach(probe => headerRow += `<th scope="col" class="px-6 py-3">${probe}</th>`);
            thead.innerHTML = headerRow + `</tr>`;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            sortedDatasets.forEach(dataset => {
                let bodyRow = `<tr class="bg-white border-b"><th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dataset-col">${dataset}</th>`;
                sortedProbes.forEach(probe => {
                    const score = pivot[dataset]?.[probe];
                    if (score !== undefined) {
                        const bgColor = `style="${getColorForValue(score)}"`;
                        bodyRow += `<td class="px-6 py-4 text-center font-mono" ${bgColor}>${score.toFixed(3)}</td>`;
                    } else {
                        // Add a specific class for N/A cells
                        bodyRow += `<td class="px-6 py-4 text-center font-mono na-cell">N/A</td>`;
                    }
                });
                tbody.innerHTML += bodyRow + `</tr>`;
            });
            table.appendChild(tbody);
        }

        function getColorForValue(value) {
            const intensity = Math.max(0, (value - 0.5) * 2);
            const g = 100 + Math.floor(120 * intensity);
            const r = 220 - Math.floor(150 * intensity);
            const b = 220 - Math.floor(150 * intensity);
            return `background-color: rgb(${r}, ${g}, ${b});`;
        }
    </script>
</body>
</html>
