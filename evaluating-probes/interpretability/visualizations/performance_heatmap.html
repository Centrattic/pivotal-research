<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Probe Performance Heatmap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        table { border-collapse: separate; border-spacing: 0; }
        th, td { border: 1px solid #e2e8f0; }
        th { position: sticky; top: 0; background-color: #f8fafc; z-index: 10; }
        .dataset-col { position: sticky; left: 0; background-color: #f8fafc; z-index: 5; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Probe Performance Heatmap</h1>
            <p class="text-gray-600 mb-6">This table shows the evaluation score (AUC) for each probe configuration across all datasets. Higher scores (greener) are better.</p>
            
            <div id="loading" class="text-center py-12">
                <p class="text-lg text-gray-500">Loading visualization data...</p>
            </div>

            <div id="visualization" class="hidden overflow-x-auto">
                <table id="heatmap-table" class="w-full text-sm text-left text-gray-500">
                    <!-- Header and body will be generated by JavaScript -->
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('visualization_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}. Make sure you are running a local server ('python -m http.server') and have run 'generate_viz_data.py'.`);
                }
                const data = await response.json();
                buildTable(data.performance);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('visualization').classList.remove('hidden');
            } catch (error) {
                document.getElementById('loading').innerHTML = `<p class="text-red-500 font-semibold">${error.message}</p>`;
            }
        });

        function buildTable(performanceData) {
            const table = document.getElementById('heatmap-table');
            const pivot = {}; // { eval_dataset: { probe_name: score } }
            const allProbes = new Set();
            const allDatasets = new Set();

            performanceData.forEach(item => {
                const probeName = `L${item.layer}_${item.component}_${item.architecture}_${item.aggregation}`;
                const datasetName = item.eval_dataset;
                const score = item.metrics.auc; // Using AUC as the primary metric

                if (!pivot[datasetName]) {
                    pivot[datasetName] = {};
                }
                pivot[datasetName][probeName] = score;
                allProbes.add(probeName);
                allDatasets.add(datasetName);
            });

            const sortedProbes = Array.from(allProbes).sort();
            const sortedDatasets = Array.from(allDatasets).sort();

            // Build Header
            const thead = document.createElement('thead');
            let headerRow = `<tr class="text-xs text-gray-700 uppercase bg-gray-100">
                                <th scope="col" class="px-6 py-3 dataset-col">Dataset</th>`;
            sortedProbes.forEach(probe => {
                headerRow += `<th scope="col" class="px-6 py-3">${probe}</th>`;
            });
            headerRow += `</tr>`;
            thead.innerHTML = headerRow;
            table.appendChild(thead);

            // Build Body
            const tbody = document.createElement('tbody');
            sortedDatasets.forEach(dataset => {
                let bodyRow = `<tr class="bg-white border-b">
                                <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dataset-col">${dataset}</th>`;
                sortedProbes.forEach(probe => {
                    const score = pivot[dataset] ? pivot[dataset][probe] : undefined;
                    const bgColor = score !== undefined ? getColorForValue(score) : 'bg-gray-100';
                    const text = score !== undefined ? score.toFixed(3) : 'N/A';
                    bodyRow += `<td class="px-6 py-4 text-center text-white font-mono ${bgColor}">${text}</td>`;
                });
                bodyRow += `</tr>`;
                tbody.innerHTML += bodyRow;
            });
            table.appendChild(tbody);
        }

        function getColorForValue(value) {
            // Simple green scale for AUC (0.5 is random, 1.0 is perfect)
            const intensity = Math.max(0, (value - 0.5) * 2); // Scale 0.5-1.0 to 0-1
            const g = 100 + Math.floor(120 * intensity);
            const r = 220 - Math.floor(150 * intensity);
            const b = 220 - Math.floor(150 * intensity);
            return `background-color: rgb(${r}, ${g}, ${b});`;
        }
    </script>
</body>
</html>
