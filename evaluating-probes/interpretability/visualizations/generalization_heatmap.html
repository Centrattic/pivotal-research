<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Probe Generalization Matrix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        table { border-collapse: separate; border-spacing: 0; }
        th, td { border: 1px solid #e2e8f0; }
        th { position: sticky; top: 0; background-color: #f8fafc; z-index: 10; }
        .train-col { position: sticky; left: 0; background-color: #f8fafc; z-index: 5; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Probe Generalization Matrix</h1>
            <p class="text-gray-600 mb-6">This table shows how well a probe trained on one dataset (row) performs when evaluated on another (column). The diagonal shows in-distribution performance.</p>
            
            <div class="mb-6">
                <label for="probe-selector" class="block mb-2 text-sm font-medium text-gray-900">Select a Probe Configuration:</label>
                <select id="probe-selector" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
            </div>

            <div id="loading" class="text-center py-12">
                <p class="text-lg text-gray-500">Loading visualization data...</p>
            </div>

            <div id="visualization" class="hidden overflow-x-auto">
                <table id="heatmap-table" class="w-full text-sm text-left text-gray-500">
                    <!-- Content generated by JS -->
                </table>
            </div>
        </div>
    </div>

    <script>
        let vizData = null;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('visualization_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}. Make sure you are running a local server ('python -m http.server') and have run 'generate_viz_data.py'.`);
                }
                vizData = await response.json();
                const allProbes = new Set(vizData.performance.map(p => `L${p.layer}_${p.component}_${p.architecture}_${p.aggregation}`));
                populateSelector(Array.from(allProbes));
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('visualization').classList.remove('hidden');
            } catch (error) {
                document.getElementById('loading').innerHTML = `<p class="text-red-500 font-semibold">${error.message}</p>`;
            }
        });

        function populateSelector(probes) {
            const selector = document.getElementById('probe-selector');
            probes.sort().forEach(probe => {
                const option = new Option(probe, probe);
                selector.add(option);
            });
            selector.addEventListener('change', (e) => buildTable(e.target.value));
            if (probes.length > 0) {
                buildTable(probes[0]);
            }
        }

        function buildTable(selectedProbe) {
            const table = document.getElementById('heatmap-table');
            table.innerHTML = ''; // Clear previous table
            
            const matrix = {}; // { train_dataset: { eval_dataset: score } }
            const allDatasets = new Set();

            vizData.performance.forEach(item => {
                const probeName = `L${item.layer}_${item.component}_${item.architecture}_${item.aggregation}`;
                if (probeName !== selectedProbe) return;

                const trainDs = item.train_dataset;
                const evalDs = item.eval_dataset;
                const score = item.metrics.auc;

                if (!matrix[trainDs]) matrix[trainDs] = {};
                matrix[trainDs][evalDs] = score;
                allDatasets.add(trainDs);
                allDatasets.add(evalDs);
            });
            
            const sortedDatasets = Array.from(allDatasets).sort();

            // Header
            const thead = document.createElement('thead');
            let headerRow = `<tr class="text-xs text-gray-700 uppercase bg-gray-100">
                                <th scope="col" class="px-6 py-3 train-col">Train On ↘ / Eval On →</th>`;
            sortedDatasets.forEach(ds => headerRow += `<th scope="col" class="px-6 py-3">${ds}</th>`);
            headerRow += `</tr>`;
            thead.innerHTML = headerRow;
            table.appendChild(thead);

            // Body
            const tbody = document.createElement('tbody');
            sortedDatasets.forEach(trainDs => {
                let bodyRow = `<tr class="bg-white border-b">
                                <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap train-col">${trainDs}</th>`;
                sortedDatasets.forEach(evalDs => {
                    const score = matrix[trainDs] ? matrix[trainDs][evalDs] : undefined;
                    const bgColor = score !== undefined ? getColorForValue(score) : 'bg-gray-100';
                    const text = score !== undefined ? score.toFixed(3) : 'N/A';
                    bodyRow += `<td class="px-6 py-4 text-center text-white font-mono ${bgColor}">${text}</td>`;
                });
                bodyRow += `</tr>`;
                tbody.innerHTML += bodyRow;
            });
            table.appendChild(tbody);
        }

        function getColorForValue(value) {
            // Green scale for AUC (0.5 is random, 1.0 is perfect)
            const intensity = Math.max(0, (value - 0.5) * 2);
            const g = 100 + Math.floor(120 * intensity);
            const r = 220 - Math.floor(150 * intensity);
            const b = 220 - Math.floor(150 * intensity);
            return `background-color: rgb(${r}, ${g}, ${b});`;
        }
    </script>
</body>
</html>
